<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Words to Review</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2678b6;
            --tg-theme-button-color: #50a8eb;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f0f0f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding: 12px;
            padding-bottom: 80px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .word-count {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
        }

        /* Burger Menu */
        .burger-btn {
            width: 36px;
            height: 36px;
            background: var(--tg-theme-secondary-bg-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            padding: 8px;
        }

        .burger-btn span {
            display: block;
            width: 18px;
            height: 2px;
            background: var(--tg-theme-text-color);
            border-radius: 1px;
            transition: all 0.3s;
        }

        .burger-btn.open span:nth-child(1) {
            transform: rotate(45deg) translate(4px, 4px);
        }

        .burger-btn.open span:nth-child(2) {
            opacity: 0;
        }

        .burger-btn.open span:nth-child(3) {
            transform: rotate(-45deg) translate(4px, -4px);
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--tg-theme-bg-color);
            z-index: 201;
            transition: left 0.3s;
            padding: 20px;
            overflow-y: auto;
        }

        .side-menu.open {
            left: 0;
        }

        .menu-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .menu-item:active {
            background: var(--tg-theme-secondary-bg-color);
        }

        .menu-item.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .menu-item-icon {
            font-size: 20px;
        }

        .menu-item-text {
            font-size: 16px;
            font-weight: 500;
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Digest Page Styles */
        .digest-card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .digest-date {
            font-size: 13px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 8px;
        }

        .digest-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .digest-text {
            font-size: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .digest-text b {
            color: var(--tg-theme-button-color);
        }

        /* Audio Mini Player */
        .audio-player {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            padding: 12px;
            background: var(--tg-theme-bg-color);
            border-radius: 12px;
        }

        .player-btn {
            width: 44px;
            height: 44px;
            min-width: 44px;
            border-radius: 50%;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .player-btn:active {
            transform: scale(0.95);
        }

        .player-btn.playing {
            background: #e74c3c;
        }

        .player-btn.loading {
            background: var(--tg-theme-hint-color);
        }

        .player-progress-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .player-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .player-progress-fill {
            height: 100%;
            background: var(--tg-theme-button-color);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .player-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--tg-theme-hint-color);
        }

        .player-status {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            text-align: center;
        }

        /* Sticky header with tabs and autoplay controls */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--tg-theme-bg-color);
            padding-bottom: 8px;
            margin: -12px -12px 12px -12px;
            padding: 12px 12px 8px 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            border-radius: 10px;
            overflow: hidden;
            background: var(--tg-theme-secondary-bg-color);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            color: var(--tg-theme-hint-color);
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .tab-btn:active {
            opacity: 0.8;
        }

        /* Autoplay controls for random tab */
        .autoplay-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .autoplay-btn {
            flex: 1;
            padding: 12px 16px;
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .autoplay-btn.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        .autoplay-btn:active {
            transform: scale(0.98);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--tg-theme-hint-color);
        }

        .error {
            text-align: center;
            padding: 40px 20px;
            color: #e74c3c;
        }

        .word-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .word-card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            transition: transform 0.1s ease;
        }

        .word-card:active {
            transform: scale(0.98);
        }

        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .word-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--tg-theme-text-color);
        }

        .audio-btn {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .audio-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .audio-btn:active:not(:disabled) {
            opacity: 0.7;
        }

        .audio-btn.playing {
            animation: pulse 0.5s infinite alternate;
        }

        /* Repeat button */
        .repeat-btn {
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .repeat-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .repeat-btn.sent {
            background: #34c759;
        }

        .repeat-btn.sending {
            opacity: 0.6;
        }

        /* Hidden translation */
        .translate.hidden {
            filter: blur(8px);
            cursor: pointer;
            user-select: none;
            transition: filter 0.3s ease;
        }

        .translate.hidden:hover {
            filter: blur(4px);
        }

        .word-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .word-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .word-number {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            min-width: 24px;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .transcript {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 8px;
            font-style: italic;
        }

        .translate {
            font-size: 16px;
            color: var(--tg-theme-text-color);
            opacity: 0.85;
        }

        .example {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.1);
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            font-style: italic;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .word-card.highlighted {
            border: 2px solid var(--tg-theme-button-color);
            background: color-mix(in srgb, var(--tg-theme-button-color) 10%, var(--tg-theme-secondary-bg-color));
        }

        /* Date groups */
        .date-groups {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .date-group {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .date-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .date-group-header:active {
            background: rgba(0,0,0,0.05);
        }

        .date-group-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .date-group-date {
            font-size: 18px;
            font-weight: 600;
            color: var(--tg-theme-text-color);
        }

        .date-group-count {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
        }

        .date-group-arrow {
            font-size: 20px;
            color: var(--tg-theme-hint-color);
            transition: transform 0.2s;
        }

        .date-group.expanded .date-group-arrow {
            transform: rotate(90deg);
        }

        .date-group-content {
            display: none;
            padding: 0 16px 16px 16px;
        }

        .date-group.expanded .date-group-content {
            display: block;
        }

        .group-autoplay-controls {
            display: none; /* Hidden - using sticky header instead */
        }

        .group-autoplay-btn {
            flex: 1;
            padding: 10px 12px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .group-autoplay-btn.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        .group-autoplay-btn:active {
            transform: scale(0.98);
        }

        .group-word-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .group-word-card {
            background: var(--tg-theme-bg-color);
            border-radius: 10px;
            padding: 12px;
        }

        .group-word-card.highlighted {
            border: 2px solid var(--tg-theme-button-color);
            background: color-mix(in srgb, var(--tg-theme-button-color) 10%, var(--tg-theme-bg-color));
        }
    </style>
</head>
<body>
    <!-- Burger Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay" data-action="close-menu"></div>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">AI Jarvis</div>
        <div class="menu-item active" data-action="navigate" data-page="words">
            <span class="menu-item-icon">üìö</span>
            <span class="menu-item-text">Vocabulary Review</span>
        </div>
        <div class="menu-item" data-action="navigate" data-page="digest">
            <span class="menu-item-icon">üì∞</span>
            <span class="menu-item-text">AI Digest</span>
        </div>
        <div class="menu-item" data-action="navigate" data-page="dictionary">
            <span class="menu-item-icon">üìñ</span>
            <span class="menu-item-text">Dictionary</span>
        </div>
    </div>

    <!-- Words Page -->
    <div class="page active" id="wordsPage">
        <div class="header">
            <div class="header-left">
                <button class="burger-btn" id="burgerBtn" data-action="toggle-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1>Words to Review</h1>
            </div>
            <span class="word-count" id="wordCount"></span>
        </div>

        <div class="sticky-header">
            <div class="tabs">
                <button class="tab-btn active" data-tab="grouped" data-action="tab">–ü–æ –¥–∞—Ç–∞–º</button>
                <button class="tab-btn" data-tab="random" data-action="tab">–°–ª—É—á–∞–π–Ω—ã–µ</button>
            </div>

            <div class="autoplay-controls" id="randomAutoplayControls" style="display: none;">
                <button class="autoplay-btn" id="autoplayEnglishBtn"
                        data-action="random-autoplay" data-mode="english">
                    ‚ñ∂ English Only
                </button>
                <button class="autoplay-btn" id="autoplayBothBtn"
                        data-action="random-autoplay" data-mode="both">
                    ‚ñ∂ Eng + Rus
                </button>
            </div>

            <div class="autoplay-controls" id="groupAutoplayControls" style="display: none;">
                <button class="autoplay-btn" id="groupAutoplayEnglishBtn"
                        data-action="group-autoplay" data-mode="english">
                    ‚ñ∂ English Only
                </button>
                <button class="autoplay-btn" id="groupAutoplayBothBtn"
                        data-action="group-autoplay" data-mode="both">
                    ‚ñ∂ Eng + Rus
                </button>
            </div>
        </div>

        <div id="content">
            <div class="loading">Loading words...</div>
        </div>

        <button class="refresh-btn" id="refreshBtn" onclick="resetAndLoad()">&#x21bb;</button>
    </div>

    <!-- Digest Page -->
    <div class="page" id="digestPage">
        <div class="header">
            <div class="header-left">
                <button class="burger-btn" data-action="toggle-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1>AI Digest</h1>
            </div>
        </div>

        <div id="digestContent">
            <div class="loading">Loading digests...</div>
        </div>

        <button class="refresh-btn" id="digestRefreshBtn" data-action="refresh-digest">&#x21bb;</button>
    </div>

    <!-- Dictionary Page -->
    <div class="page" id="dictionaryPage">
        <div class="header">
            <div class="header-left">
                <button class="burger-btn" data-action="toggle-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1>Dictionary</h1>
            </div>
            <span class="word-count" id="dictWordCount"></span>
        </div>

        <div class="sticky-header">
            <div class="autoplay-controls" id="dictAutoplayControls">
                <button class="autoplay-btn" id="dictAutoplayEnglishBtn"
                        data-action="dict-autoplay" data-mode="english">
                    ‚ñ∂ English Only
                </button>
                <button class="autoplay-btn" id="dictAutoplayBothBtn"
                        data-action="dict-autoplay" data-mode="both">
                    ‚ñ∂ Eng + Rus
                </button>
            </div>
        </div>

        <div id="dictionaryContent">
            <div class="loading">Loading dictionary...</div>
        </div>

        <button class="refresh-btn" id="dictRefreshBtn" data-action="refresh-dictionary">&#x21bb;</button>
    </div>

    <script>
        const API_URL = 'https://n8n.aimediaflow.net/webhook/words-repeat';
        const DIGEST_API_URL = 'https://n8n.aimediaflow.net/webhook/get-digests';
        const DICTIONARY_API_URL = 'https://n8n.aimediaflow.net/webhook/words-all';
        const MARK_REPEAT_API_URL = 'https://n8n.aimediaflow.net/webhook/mark-repeat';

        // State
        let dateGroups = [];
        let randomWords = [];
        let totalWords = 0;
        let isLoading = false;
        let expandedGroup = null; // date string of expanded group
        let activeGroupDate = null; // date of group with active autoplay
        let currentTab = 'grouped'; // 'grouped' or 'random'
        let currentPage = 'words'; // 'words' or 'digest'

        // Random tab autoplay state
        let randomAutoplayMode = null;
        let randomAutoplayIndex = 0;

        // Digest state
        let currentDigest = null;
        let digestAudio = null;
        let currentDigestPlayingBtn = null;

        // Dictionary state
        let dictionaryWords = [];
        let dictAutoplayMode = null;
        let dictAutoplayIndex = 0;
        let revealedTranslations = new Set(); // Track which translations are revealed

        // Initialize Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();

            // Apply Telegram theme
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#2678b6');
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#50a8eb');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f0f0f0');
        }

        let currentPlayingBtn = null;
        let autoplayMode = null; // null, 'english', 'both'
        let autoplayIndex = 0;
        let autoplayTimeout = null;
        let isAutoplayPaused = false;

        // Single reusable Audio object for Telegram compatibility
        let sharedAudio = new Audio();
        sharedAudio.volume = 1.0;
        let audioUnlocked = false;

        function resetAndLoad() {
            dateGroups = [];
            randomWords = [];
            totalWords = 0;
            expandedGroup = null;
            stopAutoplay();
            stopRandomAutoplay();
            document.getElementById('groupAutoplayControls').style.display = 'none';
            if (currentTab === 'random') {
                loadRandomWords();
            } else {
                loadWords();
            }
        }

        function switchTab(tab) {
            if (currentTab === tab) return;

            stopAutoplay();
            stopRandomAutoplay();
            currentTab = tab;
            expandedGroup = null;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
            });

            const randomControls = document.getElementById('randomAutoplayControls');
            const groupControls = document.getElementById('groupAutoplayControls');

            if (tab === 'grouped') {
                randomControls.style.display = 'none';
                groupControls.style.display = 'none';
                if (dateGroups.length > 0) {
                    renderGroups();
                    document.getElementById('wordCount').textContent = totalWords;
                } else {
                    loadWords();
                }
            } else {
                randomControls.style.display = 'flex';
                groupControls.style.display = 'none';
                loadRandomWords();
            }
        }

        async function loadWords() {
            if (isLoading) return;
            isLoading = true;

            const content = document.getElementById('content');
            const refreshBtn = document.getElementById('refreshBtn');
            const wordCount = document.getElementById('wordCount');

            refreshBtn.classList.add('spinning');
            content.innerHTML = '<div class="loading">Loading words...</div>';

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();
                dateGroups = data.dateGroups || [];
                totalWords = data.total || 0;

                wordCount.textContent = totalWords;

                if (dateGroups.length === 0) {
                    content.innerHTML = '<div class="loading">No words to review</div>';
                    return;
                }

                renderGroups();

            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = '<div class="error">Failed to load words.<br>Please try again.</div>';
            } finally {
                isLoading = false;
                refreshBtn.classList.remove('spinning');
            }
        }

        async function loadRandomWords() {
            if (isLoading) return;
            isLoading = true;

            const content = document.getElementById('content');
            const refreshBtn = document.getElementById('refreshBtn');
            const wordCount = document.getElementById('wordCount');

            refreshBtn.classList.add('spinning');
            content.innerHTML = '<div class="loading">Loading random words...</div>';

            try {
                const response = await fetch(API_URL + '?mode=random');
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();
                randomWords = data.words || [];

                wordCount.textContent = randomWords.length;

                if (randomWords.length === 0) {
                    content.innerHTML = '<div class="loading">No words to review</div>';
                    return;
                }

                renderRandomWords();

            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = '<div class="error">Failed to load words.<br>Please try again.</div>';
            } finally {
                isLoading = false;
                refreshBtn.classList.remove('spinning');
            }
        }

        function renderRandomWords() {
            const content = document.getElementById('content');

            // Update sticky autoplay buttons state
            const englishBtn = document.getElementById('autoplayEnglishBtn');
            const bothBtn = document.getElementById('autoplayBothBtn');
            englishBtn.classList.toggle('active', randomAutoplayMode === 'english');
            bothBtn.classList.toggle('active', randomAutoplayMode === 'both');

            let html = '<div class="word-list">';

            randomWords.forEach((word, index) => {
                html += renderRandomWordCard(word, index);
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function renderRandomWordCard(word, index) {
            const transcript = word.transcript && word.transcript !== 'None' ? `/${word.transcript}/` : '';
            const audioUrl = word.audio || '';
            const isHighlighted = randomAutoplayMode && randomAutoplayIndex === index;

            return `
                <div class="word-card ${isHighlighted ? 'highlighted' : ''}" data-index="${index}">
                    <div class="word-header">
                        <span class="word-text">${escapeHtml(word.word)}</span>
                        <button class="audio-btn" id="random-audio-btn-${index}"
                                data-action="play-random" data-url="${escapeHtml(audioUrl)}" data-widx="${index}">
                            &#x1F50A;
                        </button>
                    </div>
                    ${transcript ? `<div class="transcript">${escapeHtml(transcript)}</div>` : ''}
                    <div class="translate">${escapeHtml(word.translate)}</div>
                    ${word.example ? `<div class="example">"${escapeHtml(word.example)}"</div>` : ''}
                </div>
            `;
        }

        function renderGroups() {
            const content = document.getElementById('content');

            let html = '<div class="date-groups">';

            dateGroups.forEach((group, groupIndex) => {
                const isExpanded = expandedGroup === group.date;
                const formattedDate = formatDate(group.date);

                html += `
                    <div class="date-group ${isExpanded ? 'expanded' : ''}" data-date="${group.date}" data-index="${groupIndex}">
                        <div class="date-group-header" data-action="toggle" data-gidx="${groupIndex}">
                            <div class="date-group-info">
                                <span class="date-group-date">${formattedDate}</span>
                                <span class="date-group-count">${group.count} —Å–ª–æ–≤</span>
                            </div>
                            <span class="date-group-arrow">‚ñ∂</span>
                        </div>
                        <div class="date-group-content">
                            ${isExpanded ? renderGroupContent(group, groupIndex) : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'unknown') return '–ë–µ–∑ –¥–∞—Ç—ã';
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (dateStr === today.toISOString().split('T')[0]) {
                return '–°–µ–≥–æ–¥–Ω—è';
            } else if (dateStr === yesterday.toISOString().split('T')[0]) {
                return '–í—á–µ—Ä–∞';
            }

            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
            });
        }

        function toggleGroup(date) {
            const groupControls = document.getElementById('groupAutoplayControls');

            if (expandedGroup === date) {
                expandedGroup = null;
                stopAutoplay();
                groupControls.style.display = 'none';
            } else {
                stopAutoplay();
                expandedGroup = date;
                groupControls.style.display = 'flex';
                updateGroupAutoplayButtons();
            }
            renderGroups();
        }

        function updateGroupAutoplayButtons() {
            const englishBtn = document.getElementById('groupAutoplayEnglishBtn');
            const bothBtn = document.getElementById('groupAutoplayBothBtn');
            const isActiveGroup = activeGroupDate === expandedGroup;

            englishBtn.classList.toggle('active', isActiveGroup && autoplayMode === 'english');
            bothBtn.classList.toggle('active', isActiveGroup && autoplayMode === 'both');
        }

        function renderGroupContent(group, groupIndex) {
            let html = '<div class="group-word-list">';

            group.words.forEach((word, index) => {
                html += renderWordCard(word, groupIndex, index);
            });

            html += '</div>';
            return html;
        }

        function renderWordCard(word, groupIndex, index) {
            const transcript = word.transcript && word.transcript !== 'None' ? `/${word.transcript}/` : '';
            const audioUrl = word.audio || '';
            const group = dateGroups[groupIndex];
            const isHighlighted = activeGroupDate === group.date && autoplayIndex === index;

            return `
                <div class="group-word-card ${isHighlighted ? 'highlighted' : ''}" data-index="${index}">
                    <div class="word-header">
                        <span class="word-text">${escapeHtml(word.word)}</span>
                        <button class="audio-btn" id="audio-btn-${groupIndex}-${index}"
                                data-action="play" data-url="${escapeHtml(audioUrl)}" data-gidx="${groupIndex}" data-widx="${index}">
                            &#x1F50A;
                        </button>
                    </div>
                    ${transcript ? `<div class="transcript">${escapeHtml(transcript)}</div>` : ''}
                    <div class="translate">${escapeHtml(word.translate)}</div>
                    ${word.example ? `<div class="example">"${escapeHtml(word.example)}"</div>` : ''}
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let currentAudio = null;

        function playAudio(url, groupDate, wordIndex) {
            if (!url) return;

            // Stop current audio if playing
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                if (currentPlayingBtn) {
                    currentPlayingBtn.classList.remove('playing');
                }
            }

            // Haptic feedback
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }

            const groupIndex = dateGroups.findIndex(g => g.date === groupDate);
            const btn = document.getElementById(`audio-btn-${groupIndex}-${wordIndex}`);
            currentPlayingBtn = btn;
            if (btn) btn.classList.add('playing');

            currentAudio = new Audio(url);
            currentAudio.volume = 1.0;

            currentAudio.onended = () => {
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
            };

            currentAudio.onerror = (err) => {
                console.error('Audio playback failed:', err);
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            };

            currentAudio.play().catch(err => {
                console.error('Audio play error:', err);
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
            });
        }

        // Unlock audio for Telegram - must be called from user gesture
        function unlockAudio() {
            if (audioUnlocked) return Promise.resolve();

            return new Promise((resolve) => {
                // Play silent audio to unlock
                sharedAudio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAbAAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV////////////////////////////////////////////AAAAAExhdmM1OC4xMwAAAAAAAAAAAAAAACQAAAAAAAAAAQGwBPBbAAAAAAD/4xjEAAAANIAAAAAExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV/+MYxDsAAADSAAAAAFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';
                sharedAudio.volume = 0.01;
                sharedAudio.play().then(() => {
                    audioUnlocked = true;
                    sharedAudio.pause();
                    sharedAudio.volume = 1;
                    resolve();
                }).catch(() => {
                    resolve(); // Continue anyway
                });
            });
        }

        // Autoplay functions for groups
        async function toggleGroupAutoplay(groupDate, mode) {
            if (activeGroupDate === groupDate && autoplayMode === mode) {
                // Stop autoplay
                stopAutoplay();
            } else {
                // Start autoplay - first unlock audio from this user gesture
                await unlockAudio();
                stopAutoplay();
                activeGroupDate = groupDate;
                autoplayMode = mode;
                autoplayIndex = 0;
                updateGroupContent(groupDate);
                playNextWord();
            }
        }

        function updateGroupContent(groupDate) {
            const groupIndex = dateGroups.findIndex(g => g.date === groupDate);
            if (groupIndex === -1) return;

            const group = dateGroups[groupIndex];
            const groupEl = document.querySelector(`.date-group[data-index="${groupIndex}"]`);
            if (!groupEl) return;

            const contentEl = groupEl.querySelector('.date-group-content');
            if (contentEl) {
                contentEl.innerHTML = renderGroupContent(group, groupIndex);
            }
        }

        function stopAutoplay() {
            const prevGroupDate = activeGroupDate;
            autoplayMode = null;
            activeGroupDate = null;
            isAutoplayPaused = false;
            if (autoplayTimeout) {
                clearTimeout(autoplayTimeout);
                autoplayTimeout = null;
            }
            // Stop shared audio
            sharedAudio.pause();
            sharedAudio.onended = null;
            sharedAudio.onerror = null;

            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            // Remove highlights
            document.querySelectorAll('.group-word-card.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
            // Update buttons
            if (prevGroupDate) {
                updateGroupContent(prevGroupDate);
            }
        }

        function highlightWord(groupDate, index) {
            document.querySelectorAll('.group-word-card.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
            const groupIndex = dateGroups.findIndex(g => g.date === groupDate);
            if (groupIndex === -1) return;

            const groupEl = document.querySelector(`.date-group[data-index="${groupIndex}"]`);
            if (!groupEl) return;

            const cards = groupEl.querySelectorAll('.group-word-card');
            if (cards[index]) {
                cards[index].classList.add('highlighted');
                cards[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function playNextWord() {
            if (!autoplayMode || !activeGroupDate) {
                stopAutoplay();
                return;
            }

            const group = dateGroups.find(g => g.date === activeGroupDate);
            if (!group) {
                stopAutoplay();
                return;
            }

            // Loop back to start if reached end
            if (autoplayIndex >= group.words.length) {
                autoplayIndex = 0;
            }

            const word = group.words[autoplayIndex];
            highlightWord(activeGroupDate, autoplayIndex);

            if (autoplayMode === 'english') {
                // English only: word -> 1s pause -> next word
                playWordAudioAutoplay(word.audio, () => {
                    autoplayTimeout = setTimeout(() => {
                        autoplayIndex++;
                        playNextWord();
                    }, 1000);
                });
            } else if (autoplayMode === 'both') {
                // English + Russian: word -> 1s -> translation -> 2s -> next word
                playWordAudioAutoplay(word.audio, () => {
                    autoplayTimeout = setTimeout(() => {
                        speakRussian(word.translate, () => {
                            autoplayTimeout = setTimeout(() => {
                                autoplayIndex++;
                                playNextWord();
                            }, 2000);
                        });
                    }, 1000);
                });
            }
        }

        function playWordAudioAutoplay(url, onComplete) {
            if (!url || !autoplayMode) {
                if (onComplete) onComplete();
                return;
            }

            // Use shared audio object for Telegram compatibility
            sharedAudio.pause();
            sharedAudio.onended = null;
            sharedAudio.onerror = null;

            sharedAudio.src = url;
            sharedAudio.currentTime = 0;

            sharedAudio.onended = () => {
                if (onComplete) onComplete();
            };

            sharedAudio.onerror = () => {
                if (onComplete) onComplete();
            };

            sharedAudio.play().catch(() => {
                if (onComplete) onComplete();
            });
        }

        function speakRussian(text, onComplete) {
            if (!text || !window.speechSynthesis) {
                if (onComplete) onComplete();
                return;
            }

            try {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU';
                utterance.rate = 0.9;

                utterance.onend = () => {
                    if (onComplete) onComplete();
                };

                utterance.onerror = () => {
                    if (onComplete) onComplete();
                };

                window.speechSynthesis.speak(utterance);
            } catch(e) {
                if (onComplete) onComplete();
            }
        }

        // Random words autoplay
        async function toggleRandomAutoplay(mode) {
            if (randomAutoplayMode === mode) {
                stopRandomAutoplay();
            } else {
                await unlockAudio();
                stopRandomAutoplay();
                randomAutoplayMode = mode;
                randomAutoplayIndex = 0;
                renderRandomWords();
                playNextRandomWord();
            }
        }

        function stopRandomAutoplay() {
            randomAutoplayMode = null;
            if (autoplayTimeout) {
                clearTimeout(autoplayTimeout);
                autoplayTimeout = null;
            }
            sharedAudio.pause();
            sharedAudio.onended = null;
            sharedAudio.onerror = null;

            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            document.querySelectorAll('.word-card.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
        }

        function highlightRandomWord(index) {
            document.querySelectorAll('.word-card.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
            const cards = document.querySelectorAll('.word-card');
            if (cards[index]) {
                cards[index].classList.add('highlighted');
                cards[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function playNextRandomWord() {
            if (!randomAutoplayMode || randomWords.length === 0) {
                stopRandomAutoplay();
                return;
            }

            if (randomAutoplayIndex >= randomWords.length) {
                randomAutoplayIndex = 0;
            }

            const word = randomWords[randomAutoplayIndex];
            highlightRandomWord(randomAutoplayIndex);

            if (randomAutoplayMode === 'english') {
                playRandomWordAudio(word.audio, () => {
                    autoplayTimeout = setTimeout(() => {
                        randomAutoplayIndex++;
                        playNextRandomWord();
                    }, 1000);
                });
            } else if (randomAutoplayMode === 'both') {
                playRandomWordAudio(word.audio, () => {
                    autoplayTimeout = setTimeout(() => {
                        speakRussian(word.translate, () => {
                            autoplayTimeout = setTimeout(() => {
                                randomAutoplayIndex++;
                                playNextRandomWord();
                            }, 2000);
                        });
                    }, 1000);
                });
            }
        }

        function playRandomWordAudio(url, onComplete) {
            if (!url || !randomAutoplayMode) {
                if (onComplete) onComplete();
                return;
            }

            sharedAudio.pause();
            sharedAudio.onended = null;
            sharedAudio.onerror = null;

            sharedAudio.src = url;
            sharedAudio.currentTime = 0;

            sharedAudio.onended = () => {
                if (onComplete) onComplete();
            };

            sharedAudio.onerror = () => {
                if (onComplete) onComplete();
            };

            sharedAudio.play().catch(() => {
                if (onComplete) onComplete();
            });
        }

        function playRandomAudioSingle(url, wordIndex) {
            if (!url) return;

            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                if (currentPlayingBtn) {
                    currentPlayingBtn.classList.remove('playing');
                }
            }

            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }

            const btn = document.getElementById(`random-audio-btn-${wordIndex}`);
            currentPlayingBtn = btn;
            if (btn) btn.classList.add('playing');

            currentAudio = new Audio(url);
            currentAudio.volume = 1.0;

            currentAudio.onended = () => {
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
            };

            currentAudio.onerror = () => {
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
            };

            currentAudio.play().catch(() => {
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
            });
        }

        // Handle action from element - use numeric indices instead of date strings
        function handleAction(target) {
            if (!target) return false;

            const action = target.getAttribute('data-action');
            if (!action) return false;

            const gidx = target.getAttribute('data-gidx');

            if (action === 'tab') {
                const tab = target.getAttribute('data-tab');
                if (tab) {
                    switchTab(tab);
                }
                return true;
            } else if (action === 'toggle') {
                const groupIndex = parseInt(gidx);
                const group = dateGroups[groupIndex];
                if (group) {
                    toggleGroup(group.date);
                }
                return true;
            } else if (action === 'autoplay') {
                const groupIndex = parseInt(gidx);
                const group = dateGroups[groupIndex];
                const mode = target.getAttribute('data-mode');
                if (group) {
                    toggleGroupAutoplay(group.date, mode);
                }
                return true;
            } else if (action === 'play') {
                const url = target.getAttribute('data-url');
                const groupIndex = parseInt(target.getAttribute('data-gidx'));
                const wordIndex = parseInt(target.getAttribute('data-widx'));
                const group = dateGroups[groupIndex];
                if (group) {
                    playAudio(url, group.date, wordIndex);
                }
                return true;
            } else if (action === 'random-autoplay') {
                const mode = target.getAttribute('data-mode');
                toggleRandomAutoplay(mode);
                return true;
            } else if (action === 'group-autoplay') {
                const mode = target.getAttribute('data-mode');
                if (expandedGroup) {
                    toggleGroupAutoplay(expandedGroup, mode);
                    updateGroupAutoplayButtons();
                }
                return true;
            } else if (action === 'play-random') {
                const url = target.getAttribute('data-url');
                const wordIndex = parseInt(target.getAttribute('data-widx'));
                playRandomAudioSingle(url, wordIndex);
                return true;
            } else if (action === 'toggle-menu') {
                toggleMenu();
                return true;
            } else if (action === 'close-menu') {
                closeMenu();
                return true;
            } else if (action === 'navigate') {
                const page = target.getAttribute('data-page');
                navigateToPage(page);
                return true;
            } else if (action === 'refresh-digest') {
                loadDigests();
                return true;
            } else if (action === 'player-toggle') {
                toggleDigestPlayer();
                return true;
            } else if (action === 'player-seek') {
                seekDigestAudio(event);
                return true;
            } else if (action === 'refresh-dictionary') {
                loadDictionary();
                return true;
            } else if (action === 'dict-autoplay') {
                const mode = target.getAttribute('data-mode');
                toggleDictAutoplay(mode);
                return true;
            } else if (action === 'play-dict') {
                const url = target.getAttribute('data-url');
                const wordIndex = parseInt(target.getAttribute('data-widx'));
                playDictAudioSingle(url, wordIndex);
                return true;
            } else if (action === 'reveal-translate') {
                const wordIndex = parseInt(target.getAttribute('data-widx'));
                revealTranslation(wordIndex, target);
                return true;
            } else if (action === 'mark-repeat') {
                const wordId = target.getAttribute('data-word-id');
                const wordIndex = parseInt(target.getAttribute('data-widx'));
                markWordForRepeat(wordId, wordIndex);
                return true;
            }
            return false;
        }

        // Menu functions
        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            const burgerBtns = document.querySelectorAll('.burger-btn');

            menu.classList.toggle('open');
            overlay.classList.toggle('open');
            burgerBtns.forEach(btn => btn.classList.toggle('open'));
        }

        function closeMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            const burgerBtns = document.querySelectorAll('.burger-btn');

            menu.classList.remove('open');
            overlay.classList.remove('open');
            burgerBtns.forEach(btn => btn.classList.remove('open'));
        }

        function navigateToPage(page) {
            if (currentPage === page) {
                closeMenu();
                return;
            }

            // Stop any playing audio
            stopAutoplay();
            stopRandomAutoplay();
            stopDigestAudio();
            stopDictAutoplay();

            // Update menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('data-page') === page);
            });

            // Switch pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            if (page === 'words') {
                document.getElementById('wordsPage').classList.add('active');
            } else if (page === 'digest') {
                document.getElementById('digestPage').classList.add('active');
                if (!currentDigest) {
                    loadDigests();
                }
            } else if (page === 'dictionary') {
                document.getElementById('dictionaryPage').classList.add('active');
                if (dictionaryWords.length === 0) {
                    loadDictionary();
                }
            }

            currentPage = page;
            closeMenu();
        }

        // Digest functions
        async function loadDigests() {
            const content = document.getElementById('digestContent');
            const refreshBtn = document.getElementById('digestRefreshBtn');

            refreshBtn.classList.add('spinning');
            content.innerHTML = '<div class="loading">Loading digest...</div>';

            try {
                const response = await fetch(DIGEST_API_URL);
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();
                currentDigest = data.digest || null;

                if (!currentDigest) {
                    content.innerHTML = '<div class="loading">No digest available</div>';
                    return;
                }

                renderDigest();

            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = '<div class="error">Failed to load digest.<br>Please try again.</div>';
            } finally {
                refreshBtn.classList.remove('spinning');
            }
        }

        function renderDigest() {
            const content = document.getElementById('digestContent');
            const digest = currentDigest;

            if (!digest) {
                content.innerHTML = '<div class="loading">No digest available</div>';
                return;
            }

            const date = new Date(digest.createdAt);
            const formattedDate = date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                hour: '2-digit',
                minute: '2-digit'
            });

            let html = `
                <div class="digest-card">
                    <div class="digest-date">${formattedDate}</div>
                    <div class="digest-section-title">üá¨üáß English</div>
                    <div class="digest-text">${digest.text}</div>
                    <div class="audio-player" id="digestPlayer">
                        <button class="player-btn" id="playerBtn" data-action="player-toggle">
                            ‚ñ∂
                        </button>
                        <div class="player-progress-container">
                            <div class="player-progress-bar" id="playerProgressBar" data-action="player-seek">
                                <div class="player-progress-fill" id="playerProgressFill"></div>
                            </div>
                            <div class="player-time">
                                <span id="playerCurrentTime">0:00</span>
                                <span id="playerDuration">0:00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="digest-card">
                    <div class="digest-section-title">üá∑üá∫ –†—É—Å—Å–∫–∏–π</div>
                    <div class="digest-text">${digest.russianText || '–ü–µ—Ä–µ–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}</div>
                </div>
            `;

            content.innerHTML = html;
        }

        // Audio Player functions
        let playerUpdateInterval = null;

        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updatePlayerUI() {
            if (!digestAudio) return;

            const progressFill = document.getElementById('playerProgressFill');
            const currentTimeEl = document.getElementById('playerCurrentTime');
            const durationEl = document.getElementById('playerDuration');

            if (progressFill && digestAudio.duration) {
                const progress = (digestAudio.currentTime / digestAudio.duration) * 100;
                progressFill.style.width = `${progress}%`;
            }

            if (currentTimeEl) {
                currentTimeEl.textContent = formatTime(digestAudio.currentTime);
            }

            if (durationEl && digestAudio.duration) {
                durationEl.textContent = formatTime(digestAudio.duration);
            }
        }

        function toggleDigestPlayer() {
            const btn = document.getElementById('playerBtn');
            if (!btn) return;

            if (!currentDigest || !currentDigest.audioUrl) {
                // No audio URL - show message
                btn.textContent = '!';
                setTimeout(() => { btn.textContent = '‚ñ∂'; }, 1000);
                return;
            }

            if (digestAudio && !digestAudio.paused) {
                // Pause
                digestAudio.pause();
                btn.textContent = '‚ñ∂';
                btn.classList.remove('playing');
                if (playerUpdateInterval) {
                    clearInterval(playerUpdateInterval);
                    playerUpdateInterval = null;
                }
            } else if (digestAudio) {
                // Resume
                digestAudio.play();
                btn.textContent = '‚è∏';
                btn.classList.add('playing');
                playerUpdateInterval = setInterval(updatePlayerUI, 100);
            } else {
                // Start new
                startDigestAudio();
            }

            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        function startDigestAudio() {
            const btn = document.getElementById('playerBtn');
            if (!btn || !currentDigest?.audioUrl) return;

            btn.classList.add('loading');
            btn.textContent = '...';

            digestAudio = new Audio(currentDigest.audioUrl);
            digestAudio.volume = 1.0;

            digestAudio.onloadedmetadata = () => {
                updatePlayerUI();
            };

            digestAudio.oncanplay = () => {
                btn.classList.remove('loading');
                btn.classList.add('playing');
                btn.textContent = '‚è∏';
                digestAudio.play();
                playerUpdateInterval = setInterval(updatePlayerUI, 100);
            };

            digestAudio.onended = () => {
                resetPlayer();
            };

            digestAudio.onerror = () => {
                btn.classList.remove('loading');
                btn.textContent = '!';
                setTimeout(() => { btn.textContent = '‚ñ∂'; }, 2000);
                digestAudio = null;
            };
        }

        function seekDigestAudio(e) {
            if (!digestAudio || !digestAudio.duration) return;

            const progressBar = document.getElementById('playerProgressBar');
            if (!progressBar) return;

            const rect = progressBar.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const percent = clickX / rect.width;
            digestAudio.currentTime = percent * digestAudio.duration;
            updatePlayerUI();
        }

        function resetPlayer() {
            const btn = document.getElementById('playerBtn');
            const progressFill = document.getElementById('playerProgressFill');
            const currentTimeEl = document.getElementById('playerCurrentTime');

            if (playerUpdateInterval) {
                clearInterval(playerUpdateInterval);
                playerUpdateInterval = null;
            }

            if (digestAudio) {
                digestAudio.pause();
                digestAudio = null;
            }

            if (btn) {
                btn.classList.remove('playing', 'loading');
                btn.textContent = '‚ñ∂';
            }

            if (progressFill) {
                progressFill.style.width = '0%';
            }

            if (currentTimeEl) {
                currentTimeEl.textContent = '0:00';
            }
        }

        function stopDigestAudio() {
            resetPlayer();
        }

        // Dictionary functions
        async function loadDictionary() {
            const content = document.getElementById('dictionaryContent');
            const refreshBtn = document.getElementById('dictRefreshBtn');
            const wordCount = document.getElementById('dictWordCount');

            refreshBtn.classList.add('spinning');
            content.innerHTML = '<div class="loading">Loading dictionary...</div>';
            revealedTranslations.clear(); // Reset revealed state on reload

            try {
                const response = await fetch(DICTIONARY_API_URL);
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();
                dictionaryWords = data.words || [];

                wordCount.textContent = dictionaryWords.length;

                if (dictionaryWords.length === 0) {
                    content.innerHTML = '<div class="loading">No words in dictionary</div>';
                    return;
                }

                renderDictionary();

            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = '<div class="error">Failed to load dictionary.<br>Please try again.</div>';
            } finally {
                refreshBtn.classList.remove('spinning');
            }
        }

        function renderDictionary() {
            const content = document.getElementById('dictionaryContent');

            // Update autoplay buttons state
            const englishBtn = document.getElementById('dictAutoplayEnglishBtn');
            const bothBtn = document.getElementById('dictAutoplayBothBtn');
            englishBtn.classList.toggle('active', dictAutoplayMode === 'english');
            bothBtn.classList.toggle('active', dictAutoplayMode === 'both');

            let html = '<div class="word-list">';

            dictionaryWords.forEach((word, index) => {
                html += renderDictWordCard(word, index);
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function renderDictWordCard(word, index) {
            const transcript = word.transcript && word.transcript !== 'None' ? `/${word.transcript}/` : '';
            const audioUrl = word.audio || '';
            const isHighlighted = dictAutoplayMode && dictAutoplayIndex === index;
            const wordId = word._id || '';
            const isRevealed = revealedTranslations.has(index);

            return `
                <div class="word-card ${isHighlighted ? 'highlighted' : ''}" data-index="${index}">
                    <div class="word-header">
                        <div class="word-left">
                            <span class="word-number">${index + 1}.</span>
                            <span class="word-text">${escapeHtml(word.word)}</span>
                            <button class="repeat-btn" id="dict-repeat-btn-${index}"
                                    data-action="mark-repeat" data-word-id="${escapeHtml(wordId)}" data-widx="${index}"
                                    title="Mark for repeat">
                                üîÑ
                            </button>
                        </div>
                        <button class="audio-btn" id="dict-audio-btn-${index}"
                                data-action="play-dict" data-url="${escapeHtml(audioUrl)}" data-widx="${index}">
                            &#x1F50A;
                        </button>
                    </div>
                    ${transcript ? `<div class="transcript">${escapeHtml(transcript)}</div>` : ''}
                    <div class="translate ${isRevealed ? '' : 'hidden'}" data-action="reveal-translate" data-widx="${index}">${escapeHtml(word.translate)}</div>
                </div>
            `;
        }

        function playDictAudioSingle(url, wordIndex) {
            if (!url) return;

            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                if (currentPlayingBtn) {
                    currentPlayingBtn.classList.remove('playing');
                }
            }

            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }

            const btn = document.getElementById(`dict-audio-btn-${wordIndex}`);
            currentPlayingBtn = btn;
            if (btn) btn.classList.add('playing');

            currentAudio = new Audio(url);
            currentAudio.volume = 1.0;

            currentAudio.onended = () => {
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
            };

            currentAudio.onerror = () => {
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
            };

            currentAudio.play().catch(() => {
                if (btn) btn.classList.remove('playing');
                currentPlayingBtn = null;
            });
        }

        async function toggleDictAutoplay(mode) {
            if (dictAutoplayMode === mode) {
                stopDictAutoplay();
            } else {
                await unlockAudio();
                stopDictAutoplay();
                dictAutoplayMode = mode;
                dictAutoplayIndex = 0;
                renderDictionary();
                playNextDictWord();
            }
        }

        function stopDictAutoplay() {
            dictAutoplayMode = null;
            if (autoplayTimeout) {
                clearTimeout(autoplayTimeout);
                autoplayTimeout = null;
            }
            sharedAudio.pause();
            sharedAudio.onended = null;
            sharedAudio.onerror = null;

            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            document.querySelectorAll('#dictionaryContent .word-card.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
            // Update buttons
            const englishBtn = document.getElementById('dictAutoplayEnglishBtn');
            const bothBtn = document.getElementById('dictAutoplayBothBtn');
            if (englishBtn) englishBtn.classList.remove('active');
            if (bothBtn) bothBtn.classList.remove('active');
        }

        function highlightDictWord(index) {
            document.querySelectorAll('#dictionaryContent .word-card.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
            const cards = document.querySelectorAll('#dictionaryContent .word-card');
            if (cards[index]) {
                cards[index].classList.add('highlighted');
                cards[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function playNextDictWord() {
            if (!dictAutoplayMode || dictionaryWords.length === 0) {
                stopDictAutoplay();
                return;
            }

            if (dictAutoplayIndex >= dictionaryWords.length) {
                dictAutoplayIndex = 0;
            }

            const word = dictionaryWords[dictAutoplayIndex];
            highlightDictWord(dictAutoplayIndex);

            if (dictAutoplayMode === 'english') {
                playDictWordAudio(word.audio, () => {
                    autoplayTimeout = setTimeout(() => {
                        dictAutoplayIndex++;
                        playNextDictWord();
                    }, 1000);
                });
            } else if (dictAutoplayMode === 'both') {
                playDictWordAudio(word.audio, () => {
                    autoplayTimeout = setTimeout(() => {
                        speakRussian(word.translate, () => {
                            autoplayTimeout = setTimeout(() => {
                                dictAutoplayIndex++;
                                playNextDictWord();
                            }, 2000);
                        });
                    }, 1000);
                });
            }
        }

        function playDictWordAudio(url, onComplete) {
            if (!url || !dictAutoplayMode) {
                if (onComplete) onComplete();
                return;
            }

            sharedAudio.pause();
            sharedAudio.onended = null;
            sharedAudio.onerror = null;

            sharedAudio.src = url;
            sharedAudio.currentTime = 0;

            sharedAudio.onended = () => {
                if (onComplete) onComplete();
            };

            sharedAudio.onerror = () => {
                if (onComplete) onComplete();
            };

            sharedAudio.play().catch(() => {
                if (onComplete) onComplete();
            });
        }

        // Reveal translation on click
        function revealTranslation(wordIndex, element) {
            revealedTranslations.add(wordIndex);
            if (element) {
                element.classList.remove('hidden');
            }
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        // Mark word for repeat
        async function markWordForRepeat(wordId, wordIndex) {
            if (!wordId) {
                console.error('No word ID provided');
                return;
            }

            const btn = document.getElementById(`dict-repeat-btn-${wordIndex}`);
            if (!btn || btn.classList.contains('sent') || btn.classList.contains('sending')) {
                return;
            }

            btn.classList.add('sending');
            btn.textContent = '...';

            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            try {
                const response = await fetch(MARK_REPEAT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ wordId: wordId })
                });

                if (!response.ok) throw new Error('Failed to mark word');

                btn.classList.remove('sending');
                btn.classList.add('sent');
                btn.textContent = '‚úì';

                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }

            } catch (error) {
                console.error('Error marking word for repeat:', error);
                btn.classList.remove('sending');
                btn.textContent = 'üîÑ';

                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }

        // Find closest element with data-action
        function findActionElement(el) {
            while (el && el !== document.body) {
                if (el.getAttribute && el.getAttribute('data-action')) {
                    return el;
                }
                el = el.parentElement;
            }
            return null;
        }

        // Event delegation
        function onInteraction(e) {
            const target = findActionElement(e.target);
            if (target && handleAction(target)) {
                e.preventDefault();
                e.stopPropagation();
            }
        }

        // Use capturing phase for better compatibility
        document.addEventListener('click', function(e) {
            onInteraction(e);
        }, true);

        // Also listen on touchend for Telegram WebView
        let touchMoved = false;
        document.addEventListener('touchstart', function() {
            touchMoved = false;
        }, true);
        document.addEventListener('touchmove', function() {
            touchMoved = true;
        }, true);
        document.addEventListener('touchend', function(e) {
            if (!touchMoved) {
                const target = findActionElement(e.target);
                if (target && handleAction(target)) {
                    e.preventDefault();
                }
            }
        }, true);

        // Load words on start
        loadWords();
    </script>
</body>
</html>
