<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Word Sieve Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0c0e12;
            --card-bg: #161a22;
            --text-color: #e2e8f0;
            --accent-color: #38bdf8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --surface-color: #1e293b;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 8px 12px 100px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 4px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .stats {
            font-size: 11px;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .word-list {
            display: grid;
            gap: 6px;
        }

        .word-item {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #ffffff05;
            transition: all 0.1s ease;
            cursor: pointer;
            user-select: none;
        }

        .word-item.selected {
            background-color: #0ea5e908;
            border-color: #0ea5e920;
        }

        .word-item.selected .practice-btn {
            background-color: var(--accent-color);
            color: #000;
            border-color: var(--accent-color);
        }

        .content {
            flex: 1;
            min-width: 0;
        }

        .word-en {
            font-size: 14px;
            font-weight: 600;
            display: block;
            margin-bottom: 0;
        }

        .word-ru {
            font-size: 11px;
            color: var(--secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .practice-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: transparent;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.1s;
            flex-shrink: 0;
        }

        .practice-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(to top, var(--bg-color) 80%, transparent);
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: #000;
            box-shadow: 0 4px 12px #38bdf830;
        }

        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--secondary-color);
            font-size: 13px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Word Sieve <span style="color:var(--accent-color)">Pro</span></h1>
        <div class="stats" id="stats-counter">0 SELECTED</div>
    </div>

    <div id="loading">Syncing workspace...</div>
    <div id="list" class="word-list"></div>

    <div class="footer">
        <button class="btn btn-primary" onclick="submit()" id="submit-btn">Save Progress</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let words = [];
        let selectedIds = new Set();

        const listEl = document.getElementById('list');
        const loadingEl = document.getElementById('loading');
        const counterEl = document.getElementById('stats-counter');
        const submitBtn = document.getElementById('submit-btn');

        function init() {
            try {
                const params = new URLSearchParams(window.location.search);
                const data = params.get('data');
                if (!data) throw new Error('No data provided');

                words = JSON.parse(atob(data));
                // Pre-select all words by default
                words.forEach(w => selectedIds.add(w._id));

                loadingEl.style.display = 'none';
                render();
            } catch (e) {
                loadingEl.innerText = 'Error loading words. Please try again.';
                console.error(e);
            }
        }

        function render() {
            listEl.innerHTML = words.map(w => {
                const isSelected = selectedIds.has(w._id);
                return `
                    <div class="word-item ${isSelected ? 'selected' : ''}" onclick="toggle('${w._id}')">
                        <div class="content">
                            <span class="word-en">${w.word}</span>
                            <span class="word-ru">${w.translate}</span>
                        </div>
                        <div class="practice-btn">
                            ${isSelected ?
                        '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>' :
                        '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>'}
                        </div>
                    </div>
                `;
            }).join('');
            updateCounter();
        }

        function toggle(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            render(); // Re-render to update selection styles
        }

        function updateCounter() {
            counterEl.innerText = `${selectedIds.size} SELECTED`;
        }

        async function submit() {
            if (submitBtn.classList.contains('btn-loading')) return;

            const approved = words.filter(w => selectedIds.has(w._id));
            const rejected = words.filter(w => !selectedIds.has(w._id));

            submitBtn.innerText = 'Syncing...';
            submitBtn.classList.add('btn-loading');
            tg.HapticFeedback.notificationOccurred('success');

            try {
                const response = await fetch('https://aimediaflow.duckdns.org/webhook/word-clicker/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ approved, rejected })
                });

                if (response.ok) {
                    tg.close();
                } else {
                    throw new Error('Failed to save');
                }
            } catch (e) {
                alert('Save failed. Please check connection.');
                submitBtn.innerText = 'Try Again';
                submitBtn.classList.remove('btn-loading');
            }
        }

        init();
    </script>
</body>

</html>