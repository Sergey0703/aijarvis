{
    "name": "Smart Funnel: AI News Generator",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "triggerAtHour": 8
                        }
                    ]
                }
            },
            "id": "schedule-trigger",
            "name": "Schedule: Morning News",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.1,
            "position": [
                100,
                300
            ]
        },
        {
            "parameters": {
                "operation": "find",
                "collection": "words",
                "query": "={ \"stage\": \"repeat\" }",
                "options": {
                    "limit": 10
                }
            },
            "id": "mongo-get-repeat",
            "name": "MongoDB: Get Repeat Words",
            "type": "n8n-nodes-base.mongoDb",
            "typeVersion": 1.1,
            "position": [
                300,
                200
            ],
            "credentials": {
                "mongoDb": {
                    "id": "p5lVP30sDORJCo8v"
                }
            }
        },
        {
            "parameters": {
                "operation": "getAll",
                "dataTableId": {
                    "__rl": true,
                    "value": "MWNgETzBSi4cAIFo",
                    "mode": "list",
                    "cachedResultName": "News"
                },
                "returnAll": true,
                "options": {
                    "sort": {
                        "sortRules": [
                            {
                                "column": "publishedDate",
                                "direction": "descending"
                            }
                        ]
                    },
                    "limit": 5
                }
            },
            "id": "get-news-table",
            "name": "Get Fresh News",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1.1,
            "position": [
                300,
                400
            ]
        },
        {
            "parameters": {
                "jsCode": "const wordItems = $items(\"MongoDB: Get Repeat Words\");\nconst words = wordItems.length > 0 \n    ? wordItems.map(i => i.json.word ? i.json.word + \" (\" + i.json.translate + \")\" : null).filter(w => w).join(\", \") \n    : \"\";\n\nconst news = $items(\"Get Fresh News\").map(i => \"### \" + i.json.title + \"\\n\" + (i.json.text || \"\")).join(\"\\n\\n\");\n\nlet vocabTask = \"\";\nlet vocabStructure = \"\";\n\nif (words) {\n    vocabTask = `\\nYou must integrate the following vocabulary words into the narrative naturally: ${words}.`;\n    vocabStructure = `1. Start with a section: \"ðŸŽ¯ <b>Vocabulary Focus:</b>\" and list the target words with their translations (bullet points).\\n2. Insert the separator \"---START_OF_DIGEST---\" on a new line.\\n3. Then write the news digest below it.`;\n} else {\n    vocabTask = \"\\nFocus on generating a clear and interesting summary.\";\n    vocabStructure = `1. Start immediately with the separator \"---START_OF_DIGEST---\" on the first line.\\n2. Then write the news digest below it.`;\n}\n\nreturn [{ json: { \n    prompt: `Based on the following news articles:\\n\\n${news}\\n\\nTask: Write a cohesive, engaging daily digest (approx 300 words).${vocabTask}\\n\\nStructure of the response:\\n${vocabStructure}\\n\\nRequirements:\\n- Highlight the inserted words in the text in <b>bold</b> (use HTML tags <b>word</b>) if applicable.\\n- Keep the tone professional but conversational.\\n- Ensure the facts from the news are preserved.\\n- <b>CRITICAL FOR AUDIO:</b> Clearly introduce each new story/topic. Use phrases like \"First up regarding [Topic]...\", \"In other news...\", or explicitly state the headline to separate stories. Avoid a wall of text; use paragraph breaks.` \n} }];"
            },
            "id": "prepare-prompt",
            "name": "Prepare AI Prompt",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                550,
                300
            ]
        },
        {
            "parameters": {
                "modelId": "gpt-4o-mini"
            },
            "id": "openai-node",
            "name": "AI Agent (ChatGPT)",
            "type": "n8n-nodes-base.openAi",
            "typeVersion": 1,
            "position": [
                750,
                300
            ],
            "credentials": {
                "openAiApi": {
                    "id": "YOUR_OPENAI_CRED_ID"
                }
            }
        },
        {
            "parameters": {
                "operation": "upsert",
                "dataTableId": {
                    "__rl": true,
                    "value": "YOUR_NEW_TABLE_ID",
                    "mode": "list",
                    "cachedResultName": "Daily Digests"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": {
                        "date": "={{ $json.date }}",
                        "content": "={{ $json.content }}",
                        "generatedAt": "={{ $json.generatedAt }}"
                    },
                    "matchingColumns": [
                        "date"
                    ]
                },
                "options": {}
            },
            "id": "save-digest-table",
            "name": "Save Digest to Table",
            "type": "n8n-nodes-base.dataTable",
            "typeVersion": 1.1,
            "position": [
                950,
                300
            ]
        },
        {
            "parameters": {
                "mode": "manual",
                "assignments": {
                    "assignments": [
                        {
                            "id": "assign-date",
                            "name": "date",
                            "value": "={{ $today.format('yyyy-MM-dd') }}",
                            "type": "string"
                        },
                        {
                            "id": "assign-content",
                            "name": "content",
                            "value": "={{ $json.content }}",
                            "type": "string"
                        },
                        {
                            "id": "assign-generatedAt",
                            "name": "generatedAt",
                            "value": "={{ $now.toISO() }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "id": "prepare-digest-data",
            "name": "Prepare Digest Data",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                850,
                300
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "http://piper:5000",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "text",
                            "value": "={{ $json.content.replace(/<[^>]*>/g, '') }}"
                        }
                    ]
                },
                "options": {
                    "response": {
                        "response": {
                            "responseFormat": "file"
                        }
                    }
                }
            },
            "id": "piper-tts",
            "name": "Piper: Generate Audio",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                850,
                500
            ]
        },
        {
            "parameters": {
                "chatId": "940676896",
                "file": "={{ $json.data }}",
                "additionalFields": {
                    "caption": "ðŸŽ§ Audio Version"
                }
            },
            "id": "telegram-send-audio",
            "name": "Telegram: Send Audio",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                1050,
                500
            ],
            "credentials": {
                "telegramApi": {
                    "id": "YOUR_TG_CRED_ID"
                }
            }
        },
        {
            "parameters": {
                "chatId": "940676896",
                "text": "=ðŸ“° <b>Daily Smart News</b>\n\n{{ $json.content }}",
                "additionalFields": {
                    "parse_mode": "HTML"
                }
            },
            "id": "telegram-send",
            "name": "Telegeram: Send Digest",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                1150,
                300
            ],
            "credentials": {
                "telegramApi": {
                    "id": "YOUR_TG_CRED_ID"
                }
            }
        }
    ],
    "connections": {
        "Schedule: Morning News": {
            "main": [
                [
                    {
                        "node": "MongoDB: Get Repeat Words",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Get Fresh News",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "MongoDB: Get Repeat Words": {
            "main": [
                [
                    {
                        "node": "Prepare Prompt",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Fresh News": {
            "main": [
                [
                    {
                        "node": "Prepare Prompt",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Prompt": {
            "main": [
                [
                    {
                        "node": "Prepare AI Prompt",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare AI Prompt": {
            "main": [
                [
                    {
                        "node": "Basic LLM Chain",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Basic LLM Chain": {
            "main": [
                [
                    {
                        "node": "Prepare Digest Data",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Piper: Generate Audio",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Digest Data": {
            "main": [
                [
                    {
                        "node": "Save Digest to Table",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Save Digest to Table": {
            "main": [
                [
                    {
                        "node": "Telegeram: Send Digest",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Piper: Generate Audio": {
            "main": [
                [
                    {
                        "node": "Telegram: Send Audio",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}